# Per-Asset Data Schema: market_data_v2

## Overview
The `market_data_v2` table stores enriched OHLCV data with computed features for stocks, crypto, and ETFs.

---

## Data Columns by Source

### 1. PRIMARY KEYS & IDENTIFICATION (Generated)
| Column | Type | Source | Description |
|--------|------|--------|-------------|
| id | BIGSERIAL | **Generated** | Auto-incrementing primary key |
| symbol | VARCHAR(20) | **Source** | Asset ticker (AAPL, BTC, SPY, etc.) |
| asset_class | VARCHAR(10) | **Source** | Type: 'stock', 'crypto', 'etf' |
| timeframe | VARCHAR(10) | **Source** | Candle size: '5m', '15m', '30m', '1h', '4h', '1d', '1w' |
| timestamp | TIMESTAMPTZ | **Source** | Candle open time (UTC) |

---

### 2. RAW OHLCV DATA (Pulled from Source)
**Source:** Polygon.io (stocks/ETFs), Binance (crypto)

| Column | Type | Source | Asset Class | Description |
|--------|------|--------|-------------|-------------|
| open | DECIMAL(19, 10) | **Source** | All | Opening price |
| high | DECIMAL(19, 10) | **Source** | All | Highest price in period |
| low | DECIMAL(19, 10) | **Source** | All | Lowest price in period |
| close | DECIMAL(19, 10) | **Source** | All | Closing price |
| volume | BIGINT | **Source** | All | Trading volume in base currency |

---

### 3. CRYPTO-SPECIFIC RAW DATA (Pulled from Source)
**Source:** Binance API

| Column | Type | Source | Asset Class | Description |
|--------|------|--------|-------------|-------------|
| open_interest | DECIMAL(19, 8) | **Source** | crypto only | Total open contracts |
| funding_rate | DECIMAL(11, 8) | **Source** | crypto only | Perpetual contract funding rate |
| liquidations_long | DECIMAL(19, 8) | **Source** | crypto only | Long position liquidations |
| liquidations_short | DECIMAL(19, 8) | **Source** | crypto only | Short position liquidations |
| taker_buy_volume | DECIMAL(19, 8) | **Source** | crypto only | Volume by takers buying |
| taker_sell_volume | DECIMAL(19, 8) | **Source** | crypto only | Volume by takers selling |

---

### 4. UNIVERSAL COMPUTED FEATURES (Generated)
**Generated by:** `EnrichmentScheduler` / `DataEnrichmentService`

| Column | Type | Source | Description |
|--------|------|--------|-------------|
| return_1h | DECIMAL(11, 8) | **Generated** | 1-hour price return (%) |
| return_1d | DECIMAL(11, 8) | **Generated** | 1-day price return (%) |
| volatility_20 | DECIMAL(11, 8) | **Generated** | 20-period volatility (%) |
| volatility_50 | DECIMAL(11, 8) | **Generated** | 50-period volatility (%) |
| atr | DECIMAL(19, 10) | **Generated** | Average True Range (volatility measure) |
| trend_direction | VARCHAR(10) | **Generated** | 'up', 'down', 'neutral' |
| market_structure | VARCHAR(20) | **Generated** | 'bullish', 'bearish', 'range' |
| rolling_volume_20 | BIGINT | **Generated** | 20-period average volume |

---

### 5. CRYPTO-SPECIFIC COMPUTED FEATURES (Generated)
**Generated by:** `DataEnrichmentService.enrich_crypto_data()`

| Column | Type | Source | Description |
|--------|------|--------|-------------|
| delta | DECIMAL(11, 8) | **Generated** | Long volume - Short volume (buy pressure indicator) |
| buy_sell_ratio | DECIMAL(11, 8) | **Generated** | Taker buy / Taker sell volume |
| liquidation_intensity | DECIMAL(11, 8) | **Generated** | Combined liquidation pressure |
| volume_spike_score | DECIMAL(11, 8) | **Generated** | Normalized volume spike magnitude |
| long_short_ratio | DECIMAL(11, 8) | **Generated** | Long liquidations / Short liquidations |
| funding_rate_percentile | DECIMAL(5, 2) | **Generated** | Funding rate ranking (0-100) |
| exchange_inflow | DECIMAL(19, 8) | **Generated** | Net inflow to exchanges (sentiment) |
| open_interest_change | DECIMAL(11, 8) | **Generated** | Change in open interest (%) |

---

### 6. DATA QUALITY & SOURCE TRACKING (Generated)
**Generated by:** Validation pipeline

| Column | Type | Source | Description |
|--------|------|--------|-------------|
| source | VARCHAR(20) | **Generated** | 'polygon', 'binance', 'yahoo' - tracks origin |
| is_validated | BOOLEAN | **Generated** | Passed quality checks |
| quality_score | DECIMAL(3, 2) | **Generated** | 0.0-1.0 validation score |
| validation_notes | TEXT | **Generated** | Details on any validation issues |
| gap_detected | BOOLEAN | **Generated** | Missing data in period |
| volume_anomaly | BOOLEAN | **Generated** | Unusual volume detected |
| data_completeness | DECIMAL(3, 2) | **Generated** | % of expected fields present |

---

### 7. DATA INTEGRITY & VERSIONING (Generated)
**Generated by:** Amendment/correction system

| Column | Type | Source | Description |
|--------|------|--------|-------------|
| revision | INT | **Generated** | Version number (default 1) |
| amended_from | BIGINT | **Generated** | FK to original record if amended |

---

### 8. METADATA TIMESTAMPS (Generated)
**Generated by:** System

| Column | Type | Source | Description |
|--------|------|--------|-------------|
| fetched_at | TIMESTAMPTZ | **Generated** | When data was retrieved from source |
| computed_at | TIMESTAMPTZ | **Generated** | When features were computed |
| updated_at | TIMESTAMPTZ | **Generated** | Last update timestamp |

---

## Summary by Source

### Pulled from Source (11 fields)
- **OHLCV Base:** open, high, low, close, volume
- **Crypto only:** open_interest, funding_rate, liquidations_long, liquidations_short, taker_buy_volume, taker_sell_volume

### Generated by System (29 fields)
- **Identification:** id
- **Universal Features:** return_1h, return_1d, volatility_20, volatility_50, atr, trend_direction, market_structure, rolling_volume_20
- **Crypto Features:** delta, buy_sell_ratio, liquidation_intensity, volume_spike_score, long_short_ratio, funding_rate_percentile, exchange_inflow, open_interest_change
- **Quality Tracking:** source, is_validated, quality_score, validation_notes, gap_detected, volume_anomaly, data_completeness
- **Versioning:** revision, amended_from
- **Timestamps:** fetched_at, computed_at, updated_at

### User-Specified Inputs (4 fields)
- symbol, asset_class, timeframe, timestamp

---

## Data Flow Example: Bitcoin 1H Candle

**Input from Binance:**
- open, high, low, close, volume, open_interest, funding_rate, liquidations_long, liquidations_short, taker_buy_volume, taker_sell_volume

**Generated Automatically:**
1. Quality validation → is_validated, quality_score, validation_notes, gap_detected, volume_anomaly
2. Feature computation → return_1h, return_1d, volatility_20, volatility_50, atr, delta, buy_sell_ratio, liquidation_intensity, etc.
3. Metadata → id, source='binance', fetched_at, computed_at, updated_at

**Final Row: 49 columns per candle**

